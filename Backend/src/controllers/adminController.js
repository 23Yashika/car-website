const SellRequest = require("../models/SellRequest");
const Car = require("../models/Car");
const BuyerDetails = require("../models/BuyerDetails");
const AdminExpenseMaster = require("../models/AdminExpenseMaster");
const SellerDocumentMaster = require("../models/SellerDocumentMaster");
const Sale = require("../models/Sale");
const Payment = require("../models/Payment");
const Loan = require("../models/Loan");
const PDFDocument = require("pdfkit");
const cloudinary = require("../config/cloudinary");
const { Readable } = require("stream");


// ===============================
// GET /api/admin/sell-requests
// ===============================
exports.getPendingSellRequests = async (req, res) => {
  const requests = await SellRequest.find({ status: "PENDING" }).sort({
    createdAt: -1,
  });

  res.json(requests);
};

// ===============================
// PUT /api/admin/approve/:id
// ===============================

exports.approveSellRequest = async (req, res) => {
  try {
    const { id } = req.params;
    const {
      adminSellingPrice,
      adminExpenses = [],
      sellerDocuments = [],
    } = req.body;

    const request = await SellRequest.findById(id);

    if (!request) {
      return res.status(404).json({ message: "Sell request not found" });
    }

    // üî• SAFETY LOG
    console.log("SELL REQUEST IMAGES:", request.car.images);
    console.log("ADMIN EXPENSES:", adminExpenses);
    console.log("SELLER DOCUMENTS:", sellerDocuments);

    /* ================================
       SAVE NEW EXPENSE LABELS (DROPDOWN)
    ================================= */
    if (Array.isArray(adminExpenses)) {
      for (const exp of adminExpenses) {
        if (exp.label) {
          await AdminExpenseMaster.updateOne(
            { label: exp.label.trim() },
            { $setOnInsert: { label: exp.label.trim() } },
            { upsert: true }
          );
        }
      }
    }

    /* ==================================
       SAVE NEW DOCUMENT LABELS (DROPDOWN)
    =================================== */
    if (Array.isArray(sellerDocuments)) {
      for (const doc of sellerDocuments) {
        if (doc.label) {
          await SellerDocumentMaster.updateOne(
            { label: doc.label.trim() },
            { $setOnInsert: { label: doc.label.trim() } },
            { upsert: true }
          );
        }
      }
    }

    /* ================================
       UPDATE SELL REQUEST
    ================================= */
    request.adminSellingPrice = Number(adminSellingPrice);
    request.adminExpenses = adminExpenses.map((e) => ({
      label: e.label,
      amount: Number(e.amount),
    }));
    request.sellerDocuments = sellerDocuments.map((d) => ({
      label: d.label,
      fileUrls: Array.isArray(d.fileUrls) ? d.fileUrls : [],
    }));

    request.status = "APPROVED";
    request.approvedAt = new Date();

    await request.save();

    /* ================================
       CREATE LIVE CAR (NO CHANGE)
    ================================= */
    const car = await Car.create({
      sellRequestId: request._id,

      source: request.source,

      seller: request.seller, // ‚úÖ FULL seller object

      adminExpenses: request.adminExpenses || [],
      sellerDocuments: request.sellerDocuments || [],

      car: request.car, // ‚úÖ FULL car object (brand, model, images, etc)

      sellerPrice: request.sellerPrice,
      adminSellingPrice: request.adminSellingPrice,

      rcDetails: request.rcDetails,

      status: "LIVE",
    });


    return res.status(200).json({
      message: "Car approved & LIVE",
      car,
      seller: request.seller,
      sellRequestId: request._id,
    });
  } catch (error) {
    console.error("approveSellRequest ERROR:", error);
    return res.status(500).json({ message: "Server error" });
  }
};


// ===============================
// POST /api/admin/offline-car
// ===============================
exports.addOfflineCar = async (req, res) => {
  try {


    const { seller, car, rcDetails, sellerPrice, adminSellingPrice } = req.body;

    // ================= ADMIN EXPENSES =================
    let adminExpenses = [];
    if (req.body.adminExpenses) {
      try {
        adminExpenses = JSON.parse(req.body.adminExpenses);
      } catch (err) {
        console.log("‚ùå Invalid adminExpenses JSON");
      }
    }

    // ================= SELLER DOCUMENTS =================
    let sellerDocuments = [];   // ‚úÖ DEFINE HERE

    if (req.body.documents) {
      if (!Array.isArray(req.body.documents)) {
        req.body.documents = [req.body.documents];
      }

      sellerDocuments = req.body.documents.map((doc, index) => {
        const filesKey = `documents[${index}][file]`;

        return {
          label: doc.label,
          fileUrls: req.files?.[filesKey]
            ? req.files[filesKey].map((f) => f.path)
            : [],
        };
      });
    }

    // ================= VALIDATION =================
    if (!seller?.name || !seller?.phone || !seller?.city) {
      return res.status(400).json({ message: "Missing required seller details" });
    }

    if (!car?.brand || !car?.year || !car?.fuelType || !car?.kmDriven) {
      return res.status(400).json({ message: "Missing required car details" });
    }

    if (!sellerPrice || sellerPrice <= 0) {
      return res.status(400).json({ message: "Invalid seller price" });
    }

    if (!req.files || !req.files.rcImage) {
      return res.status(400).json({ message: "RC image is required" });
    }

    if (!req.files || req.files.images.length < 4) {
      return res.status(400).json({ message: "Minimum 4 car images required" });
    }

    // ================= FILE UPLOAD =================
    const rcImageUrl = req.files.rcImage[0].path;
    const carImageUrls = req.files.images.map((file) => file.path);

    // ================= CREATE SELL REQUEST =================
    const sellRequest = await SellRequest.create({
      source: "OFFLINE",
      seller,
      car: {
        ...car,
        images: carImageUrls,
      },
      rcDetails: {
        ...rcDetails,
        rcImage: rcImageUrl,
      },

      adminExpenses,      // ‚úÖ FIXED
      sellerDocuments,    // ‚úÖ FIXED

      sellerPrice: Number(sellerPrice),
      adminSellingPrice: Number(adminSellingPrice) || Number(sellerPrice),
      status: "APPROVED",
    });

    // ================= CREATE LIVE CAR =================
    const liveCar = await Car.create({
      sellRequestId: sellRequest._id,

      source: "OFFLINE",

      seller: sellRequest.seller,

      adminExpenses: sellRequest.adminExpenses || [],
      sellerDocuments: sellRequest.sellerDocuments || [],

      car: sellRequest.car,

      sellerPrice: sellRequest.sellerPrice,
      adminSellingPrice: sellRequest.adminSellingPrice,

      rcDetails: sellRequest.rcDetails,

      status: "LIVE",
    });



    res.status(201).json({
      message: "‚úÖ Offline car added & LIVE",
      sellRequest,
      liveCar,
    });

  } catch (error) {
    console.error("addOfflineCar ERROR:", error);
    res.status(500).json({ message: error.message || "Server Error" });
  }
};


// ===============================
// PUT /api/admin/reject/:id
// ===============================
exports.rejectSellRequest = async (req, res) => {
  try {
    const { id } = req.params;
    const { reason } = req.body;

    if (!reason) {
      return res.status(400).json({
        message: "Reject reason is required",
      });
    }

    const request = await SellRequest.findById(id);

    if (!request) {
      return res.status(404).json({
        message: "Sell request not found",
      });
    }

    request.status = "REJECTED";
    request.rejectReason = reason;

    await request.save();

    res.status(200).json({
      message: "Sell request rejected successfully",
    });
  } catch (error) {
    console.error("rejectSellRequest ERROR:", error);
    res.status(500).json({
      message: "Internal server error",
    });
  }
};


// ===============================
// GET /api/admin/dashboard-stats
// ===============================

exports.getDashboardStats = async (req, res) => {
  try {
    // ================= SELL REQUEST STATS =================
    const pendingRequests = await SellRequest.countDocuments({ status: "PENDING" });
    const approvedRequests = await SellRequest.countDocuments({ status: "APPROVED" });
    const rejectedRequests = await SellRequest.countDocuments({ status: "REJECTED" });

    // ================= CARS =================
    const liveCars = await Car.countDocuments({ status: "LIVE" });
    const soldCars = await Car.countDocuments({ status: "SOLD" });

    // ================= TOTAL REVENUE (FROM SALES) =================
    const sales = await Sale.find().select("paymentSummary");

    const totalRevenue = sales.reduce((sum, sale) => {
      if (!sale.paymentSummary) return sum;

      return sum + (sale.paymentSummary.paidAmount || 0);
    }, 0);

    res.status(200).json({
      pendingRequests,
      approvedRequests,
      rejectedRequests,
      liveCars,
      soldCars,
      totalRevenue, // ‚úÖ NOW CORRECT
    });

  } catch (error) {
    console.error("getDashboardStats ERROR:", error);
    res.status(500).json({
      message: "Failed to load dashboard stats",
    });
  }
};





// ================= SOLD =================
exports.markCarAsSold = async (req, res) => {
  try {
    /* ================= EXTRACT DATA ================= */
    const buyerDetails = req.body.buyerDetails || {};
    const payment = req.body.payment || {};

    const {
      type: paymentType = "CASH", // CASH | UPI | BANK | LOAN
      cashPaid = 0,
      cashPaymentMode,
      loanTotal = 0,
      loanPaidNow = 0,
      financeCompany = "",
    } = payment;

    const {
      buyerName,
      buyerPhone,
      buyerEmail = "",
      buyerCity = "",
      soldPrice,
      saleDate,
    } = buyerDetails;

    const { carId } = req.params;

    /* ================= BASIC VALIDATION ================= */
    if (!buyerName || !buyerPhone || !soldPrice) {
      return res.status(400).json({
        message: "buyerName, buyerPhone and soldPrice are required",
      });
    }

    const soldPriceNum = Number(soldPrice);
    const cashPaidNum = Number(cashPaid);
    const loanTotalNum = Number(loanTotal);
    const loanPaidNowNum = Number(loanPaidNow);

    if (Number.isNaN(soldPriceNum) || soldPriceNum <= 0) {
      return res.status(400).json({
        message: "Invalid sold price",
      });
    }

    /* ================= PAYMENT LOGIC ================= */
    const totalPaidNow = cashPaidNum + loanPaidNowNum;
    const remainingAmount = soldPriceNum - totalPaidNow;

    if (totalPaidNow > soldPriceNum) {
      return res.status(400).json({
        message: "Total paid amount cannot exceed sold price",
      });
    }

    // üîí Strict payment rules
    if (paymentType === "LOAN") {
      if (loanTotalNum <= 0) {
        return res.status(400).json({
          message: "Loan total amount is required for loan payment",
        });
      }
    } else {
      if (cashPaidNum <= 0) {
        return res.status(400).json({
          message: "Paid amount is required",
        });
      }
    }

    /* ================= FILE VALIDATION ================= */
    if (
      !req.files?.buyerAadhaarPhoto?.length ||
      !req.files?.buyerPANPhoto?.length ||
      !req.files?.buyerPhoto?.length
    ) {
      return res.status(400).json({
        message: "Buyer Aadhaar, PAN and Photo are required",
      });
    }

    if (!req.files?.form29?.length || !req.files?.form30?.length) {
      return res.status(400).json({
        message: "Form 29 and Form 30 are required",
      });
    }

    /* ================= FIND CAR ================= */
    const car = await Car.findById(carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= UPDATE CAR ================= */
    car.status = "SOLD";
    car.soldAt = saleDate ? new Date(saleDate) : new Date();

    car.buyer = {
      name: buyerName,
      phone: buyerPhone,
      email: buyerEmail,
      city: buyerCity,
    };

    car.buyerPrice = soldPriceNum;

    /* ================= PAYMENT INFO ================= */
    car.payment = {
      type: paymentType,
      cashPaid: cashPaidNum,
      cashPaymentMode:
        paymentType === "LOAN"
          ? cashPaymentMode || "CASH"
          : paymentType,
      loanTotal: loanTotalNum,
      loanPaidNow: loanPaidNowNum,
      financeCompany: financeCompany || "",
    };

    car.sale = {
      totalAmount: soldPriceNum,
      paidAmount: totalPaidNow,
      remainingAmount,
    };

    /* ================= SAVE FILES ================= */
    car.buyerKyc = {
      aadhaar: req.files.buyerAadhaarPhoto.map(f => f.path),
      pan: req.files.buyerPANPhoto.map(f => f.path),
      photo: req.files.buyerPhoto.map(f => f.path),
    };

    car.buyerRto = {
      form29: req.files.form29.map(f => f.path),
      form30: req.files.form30.map(f => f.path),
      form28: req.files.form28?.map(f => f.path) || [],
      form35: req.files.form35?.map(f => f.path) || [],
    };

    /* ================= EXTRA ADMIN EXPENSES ================= */
    let extraAdminExpenses = [];
    if (req.body.extraAdminExpensesJson) {
      try {
        extraAdminExpenses = JSON.parse(req.body.extraAdminExpensesJson);
      } catch {
        extraAdminExpenses = [];
      }
    }

    extraAdminExpenses = extraAdminExpenses.filter(
      e => e.label && Number(e.amount) > 0
    );

    car.adminExpenses = [
      ...(car.adminExpenses || []),
      ...extraAdminExpenses,
    ];

    await car.save();

    /* ================= CREATE SALE RECORD ================= */
    const saleRecord = await Sale.create({

      carId: car._id,
      soldPrice: soldPriceNum,
      saleDate: car.soldAt,
      paymentSummary: {
        totalAmount: soldPriceNum,
        paidAmount: totalPaidNow,
        remainingAmount,
        status:
          remainingAmount === 0
            ? "PAID"
            : totalPaidNow > 0
              ? "PARTIAL"
              : "PENDING",
      },
    });

    /* ================= CREATE PAYMENT ENTRIES ================= */

    let paidSoFar = 0;

    // üîπ CASH / UPI / BANK (including loan + cash)
    if (cashPaidNum > 0) {
      paidSoFar = cashPaidNum;

      await Payment.create({
        saleId: saleRecord._id,
        carId: car._id,

        amount: cashPaidNum,
        paymentType:
          paymentType === "LOAN" ? "CASH" : paymentType,

        paymentMode:
          paymentType === "LOAN"
            ? cashPaymentMode || "CASH"
            : paymentType,

        note: `${paymentType === "LOAN"
          ? cashPaymentMode || "CASH"
          : paymentType} payment received`,

        // ‚úÖ SNAPSHOT
        paidTillNow: paidSoFar,
        remainingAfterPayment: soldPriceNum - paidSoFar,

        invoiceDate: new Date(),
      });
    }

    // üîπ LOAN DISBURSEMENT
    if (loanPaidNowNum > 0) {
      paidSoFar += loanPaidNowNum;

      await Payment.create({
        saleId: saleRecord._id,
        carId: car._id,

        amount: loanPaidNowNum,
        paymentType: "LOAN",
        note: "Loan amount disbursed",

        // ‚úÖ SNAPSHOT
        paidTillNow: paidSoFar,
        remainingAfterPayment: soldPriceNum - paidSoFar,

        invoiceDate: new Date(),
      });
    }


    /* ================= RESPONSE ================= */
    return res.status(200).json({
      message: "‚úÖ Car marked as SOLD successfully",
      car,
      sale: saleRecord,
    });

  } catch (error) {
    console.error("‚ùå markCarAsSold error:", error);
    return res.status(500).json({
      message: "Server Error",
      error: error.message,
    });
  }
};




// ===============================
// GET /api/admin/sales
// ===============================
exports.getAllSales = async (req, res) => {
  try {
    /* ================= FIND SALES ================= */
    const sales = await Sale.find()
      .sort({ createdAt: -1 })
      .populate("carId");

    /* ================= FORMAT RESPONSE ================= */
    const result = sales.map((sale) => {
      const car = sale.carId;

      return {
        saleId: sale._id,

        car: {
          brand: car?.car?.brand,
          variant: car?.car?.variant,
        },

        buyer: {
          name: car?.buyer?.name,
          phone: car?.buyer?.phone,
        },

        totalAmount: sale.paymentSummary.totalAmount,
        paidAmount: sale.paymentSummary.paidAmount,
        remainingAmount: sale.paymentSummary.remainingAmount,
        status: sale.paymentSummary.status,

        // ‚úÖ FIX: payment mode expose
        paymentMode:
          car?.payment?.cashPaymentMode ||
          car?.payment?.type ||
          "‚Äî",

        soldAt: sale.saleDate,
      };
    });

    res.status(200).json(result);
  } catch (error) {
    console.error("‚ùå getAllSales error:", error);
    res.status(500).json({
      message: "Failed to fetch sales",
      error: error.message,
    });
  }
};



// ===============================
// POST /api/admin/sales/:saleId/payments
// ===============================
exports.addPaymentToSale = async (req, res) => {
  try {
    const { saleId } = req.params;
    const { amount, paymentType, paymentMode, note } = req.body;

    /* ================= VALIDATION ================= */
    const amountNum = Number(amount);
    if (!amountNum || amountNum <= 0) {
      return res.status(400).json({
        message: "Payment amount must be greater than 0",
      });
    }

    if (!paymentType) {
      return res.status(400).json({
        message: "paymentType is required",
      });
    }

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(saleId);
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    const remainingBefore = sale.paymentSummary.remainingAmount;

    if (amountNum > remainingBefore) {
      return res.status(400).json({
        message: "Payment amount cannot exceed remaining balance",
      });
    }

    /* ================= FIND CAR ================= */
    const car = await Car.findById(sale.carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= SNAPSHOT CALCULATION ================= */
    const paidTillNow =
      sale.paymentSummary.paidAmount + amountNum;

    const remainingAfterPayment =
      sale.paymentSummary.totalAmount - paidTillNow;

    /* ================= INVOICE ================= */
    const generateInvoiceNumber = () => {
      const year = new Date().getFullYear();
      const random = Math.floor(1000 + Math.random() * 9000);
      return `INV-${year}-${random}`;
    };

    /* ================= CREATE PAYMENT ================= */
    const payment = await Payment.create({
      saleId: sale._id,
      carId: car._id,

      amount: amountNum,
      paymentType,
      paymentMode,
      note: note || "Additional payment",

      // ‚úÖ SNAPSHOT (THE FIX)
      paidTillNow,
      remainingAfterPayment,

      invoiceNumber: generateInvoiceNumber(),
      invoiceDate: new Date(),
      paymentDate: new Date(),
    });

    /* ================= UPDATE SALE ================= */
    sale.paymentSummary.paidAmount = paidTillNow;
    sale.paymentSummary.remainingAmount = remainingAfterPayment;

    sale.paymentSummary.status =
      remainingAfterPayment === 0
        ? "PAID"
        : paidTillNow > 0
          ? "PARTIAL"
          : "PENDING";

    await sale.save();

    return res.status(201).json({
      message: "‚úÖ Payment added successfully",
      payment,
      saleSummary: sale.paymentSummary,
    });

  } catch (error) {
    console.error("‚ùå addPaymentToSale error:", error);
    res.status(500).json({
      message: "Server error",
      error: error.message,
    });
  }
};



// ===============================
// GET /api/admin/sales/:saleId
// ===============================
exports.getSaleDetails = async (req, res) => {
  try {
    const { saleId } = req.params;

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(saleId);
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    /* ================= FIND CAR ================= */
    // ‚úÖ FIX: payment field include
    const car = await Car.findById(sale.carId).select(
      "car seller buyer status buyerPrice soldAt payment"
    );

    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= FIND PAYMENTS ================= */
    const payments = await Payment.find({ saleId }).sort({ createdAt: 1 });

    /* ================= FIND LOAN ================= */
    const loan = await Loan.findOne({ saleId });

    /* ================= RESPONSE ================= */
    res.status(200).json({
      sale,

      // ‚úÖ car.payment now available on frontend
      car,

      // payments should already include paymentMode
      payments,
      loan,
    });
  } catch (error) {
    console.error("‚ùå getSaleDetails error:", error);
    res.status(500).json({
      message: "Server error",
      error: error.message,
    });
  }
};


exports.getSellRequestById = async (req, res) => {
  try {
    const { id } = req.params;

    if (!id || !id.match(/^[0-9a-fA-F]{24}$/)) {
      return res.status(400).json({
        message: "Invalid request id",
      });
    }

    const request = await SellRequest.findById(id);

    if (!request) {
      return res.status(404).json({
        message: "Sell request not found",
      });
    }

    // ‚úÖ FRONTEND-SPECIFIC RESPONSE SHAPE
    const response = {
      carDetails: request.car,
      images: request.car?.images || [],
      contact: request.seller,
      expectedPrice: request.sellerPrice,
      rcDetails: request.rcDetails,
      adminSellingPrice: request.adminSellingPrice,
    };

    res.status(200).json(response);
  } catch (error) {
    console.error("getSellRequestById ERROR:", error);
    res.status(500).json({
      message: "Server error",
    });
  }
};

// ===============================
// GET /api/admin/payments/:paymentId
// ===============================
exports.getPaymentInvoice = async (req, res) => {
  try {
    const { paymentId } = req.params;

    /* ================= FIND PAYMENT ================= */
    const payment = await Payment.findById(paymentId).lean();
    if (!payment) {
      return res.status(404).json({ message: "Payment not found" });
    }

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(payment.saleId).lean();
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    /* ================= FIND CAR ================= */
    const carDoc = await Car.findById(payment.carId).lean();
    if (!carDoc) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= NORMALIZE CAR DATA ================= */
    const car = {
      // vehicle
      brand: carDoc.brand || carDoc.car?.brand || "",
      variant: carDoc.variant || carDoc.car?.variant || "",
      fuelType: carDoc.fuelType || carDoc.car?.fuelType || "",
      registrationNumber:
        carDoc.registrationNumber ||
        carDoc.car?.registrationNumber ||
        "",

      // buyer
      buyer: carDoc.buyer || {},

      // dates
      soldAt: carDoc.soldAt || null,
    };

    /* ================= RESPONSE ================= */
    return res.status(200).json({
      payment,
      sale,
      car,
    });

  } catch (error) {
    console.error("‚ùå getPaymentInvoice error:", error);
    return res.status(500).json({
      message: "Server error",
      error: error.message,
    });
  }
};


// ===============================
// GET PAYMENT INVOICE PDF
// ===============================
exports.getPaymentInvoicePDF = async (req, res) => {
  try {
    const { paymentId } = req.params;

    /* ================= FIND PAYMENT ================= */
    const payment = await Payment.findById(paymentId).lean();
    if (!payment) {
      return res.status(404).json({ message: "Payment not found" });
    }

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(payment.saleId).lean();
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    /* ================= FIND CAR ================= */
    const carDoc = await Car.findById(payment.carId).lean();
    if (!carDoc) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= PDF SETUP ================= */
    const doc = new PDFDocument({ margin: 50 });

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename=Payment-Invoice-${paymentId}.pdf`
    );

    doc.pipe(res);

    /* ================= HEADER ================= */
    doc.fontSize(18).text("Prajapati Mukati Motors", { align: "center" });
    doc.moveDown(0.5);
    doc.fontSize(10).text("Authorized Used Car Dealer", { align: "center" });
    doc.moveDown();

    doc.fontSize(14).text("PAYMENT RECEIPT", { align: "center" });
    doc.moveDown(2);

    /* ================= INVOICE DETAILS ================= */
    doc.fontSize(11).text(`Invoice No: ${payment.invoiceNumber}`);
    doc.text(`Date: ${new Date(payment.invoiceDate).toLocaleDateString()}`);
    doc.moveDown();

    /* ================= BUYER ================= */
    doc.text(`Buyer Name: ${carDoc.buyer?.name || "-"}`);
    doc.text(`Phone: ${carDoc.buyer?.phone || "-"}`);
    doc.text(`City: ${carDoc.buyer?.city || "-"}`);
    doc.moveDown();

    /* ================= VEHICLE ================= */
    doc.text(`Car: ${carDoc.brand} ${carDoc.variant || ""}`);
    doc.text(`Registration No: ${carDoc.registrationNumber || "-"}`);
    doc.text(`Fuel: ${carDoc.fuelType || "-"}`);
    doc.moveDown();

    /* ================= PAYMENT DETAILS ================= */
    doc.text(`Payment Type: ${payment.paymentType}`);
    doc.text(`Payment Method: ${payment.paymentMethod || "-"}`);
    doc.text(`Amount Paid: ‚Çπ${payment.amount.toLocaleString("en-IN")}`);
    doc.text(`Date: ${new Date(payment.paymentDate).toLocaleDateString()}`);
    doc.moveDown();

    /* ================= SALE SUMMARY ================= */
    doc.text(`Total Vehicle Price: ‚Çπ${sale.paymentSummary.totalAmount.toLocaleString("en-IN")}`);
    doc.text(`Total Paid: ‚Çπ${sale.paymentSummary.paidAmount.toLocaleString("en-IN")}`);
    doc.text(`Remaining: ‚Çπ${sale.paymentSummary.remainingAmount.toLocaleString("en-IN")}`);
    doc.text(`Status: ${sale.paymentSummary.status}`);
    doc.moveDown(2);

    doc.text("Thank you for your business!", { align: "center" });
    doc.moveDown(0.5);
    doc.text("This is a system generated receipt.", { align: "center" });

    doc.end();
  } catch (error) {
    console.error("‚ùå getPaymentInvoicePDF error:", error);
    res.status(500).json({ message: "Server error" });
  }
};


// ===============================
// GET FINAL CONSOLIDATED INVOICE
// ===============================
exports.getFinalInvoice = async (req, res) => {
  try {
    const { saleId } = req.params;

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(saleId);
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    if (sale.paymentSummary.status !== "PAID") {
      return res.status(400).json({
        message: "Final invoice available only after full payment",
      });
    }

    /* ================= FIND CAR ================= */
    const car = await Car.findById(sale.carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= FIND PAYMENTS ================= */
    const payments = await Payment.find({ saleId: sale._id }).sort({
      paymentDate: 1,
    });

    /* ================= GENERATE FINAL INVOICE NO ================= */
    const year = new Date().getFullYear();
    const finalInvoiceNumber = `FIN-${year}-${sale._id
      .toString()
      .slice(-5)}`;

    res.status(200).json({
      finalInvoiceNumber,
      sale,
      car,
      payments,
      generatedAt: new Date(),
    });
  } catch (error) {
    console.error("‚ùå getFinalInvoice error:", error);
    res.status(500).json({
      message: "Server error",
      error: error.message,
    });
  }
};


// ===============================
// PUT /api/admin/sell-requests/:id
// ===============================
exports.updateSellRequest = async (req, res) => {
  try {
    const { id } = req.params;
    const { expectedPrice, adminSellingPrice } = req.body;

    const request = await SellRequest.findById(id);

    if (!request) {
      return res.status(404).json({ message: "Sell request not found" });
    }

    // Update prices if provided
    if (expectedPrice !== undefined) {
      request.sellerPrice = Number(expectedPrice);
    }
    if (adminSellingPrice !== undefined) {
      request.adminSellingPrice = Number(adminSellingPrice);
    }

    // Update images if provided
    if (req.files && req.files.length > 0) {
      const newImageUrls = req.files.map(file => file.path);
      request.car.images = [...(request.car.images || []), ...newImageUrls];
    }

    res.status(200).json({
      message: "Sell request updated successfully",
      request
    });
  } catch (error) {
    console.error("updateSellRequest ERROR:", error);
    res.status(500).json({ message: "Server error" });
  }
};



exports.getApprovedRequests = async (req, res) => {
  try {
    const approved = await SellRequest.find({
      status: "APPROVED",
    }).sort({ updatedAt: -1 });

    res.json(approved);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Failed to fetch approved requests" });
  }
};


exports.getRejectedRequests = async (req, res) => {
  try {
    const rejected = await SellRequest.find({
      status: "REJECTED",
    }).sort({ updatedAt: -1 });

    res.status(200).json(rejected);
  } catch (error) {
    console.error("getRejectedRequests ERROR:", error);
    res.status(500).json({
      message: "Failed to fetch rejected requests",
    });
  }
};

exports.getLiveCars = async (req, res) => {
  try {
    const cars = await Car.find({
      status: { $in: ["LIVE", "SOLD"] },
    }).sort({ createdAt: -1 });

    res.status(200).json(cars);
  } catch (err) {
    res.status(500).json({ message: "Failed to fetch cars" });
  }
};


// ===============================
// GET /api/cars/:id  (PUBLIC)
// ===============================
exports.getCarById = async (req, res) => {
  try {
    const car = await Car.findById(req.params.id)
      .populate("sellRequestId");

    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    const sell = car.sellRequestId;

    res.status(200).json({
      _id: car._id,

      // ===== CAR =====
      brand: car.car?.brand,
      variant: car.car?.variant,
      year: car.car?.year,
      fuelType: car.car?.fuelType,
      kmDriven: car.car?.kmDriven,
      registrationNumber: car.car?.registrationNumber || null,
      transmission: car.car?.transmission || null,
      condition: car.car?.condition || null,
      images: car.car?.images || [],

      // ===== PRICES =====
      sellerPrice: car.sellerPrice,
      adminSellingPrice: car.adminSellingPrice,

      // ===== STATUS =====
      status: car.status,
      source: car.source,
      createdAt: car.createdAt,

      // ===== SELLER =====
      seller: sell?.seller || {},

      // ===== SELL REQUEST DATA (üî• IMPORTANT) =====
      adminExpenses: sell?.adminExpenses || [],
      sellerDocuments: sell?.sellerDocuments || [],
      rcDetails: sell?.rcDetails || {},

      sellRequestId: sell?._id,
    });
  } catch (error) {
    console.error("getCarById ERROR:", error);
    res.status(500).json({ message: "Server error" });
  }
};



/* ===============================
   GET EXPENSE DROPDOWN OPTIONS
================================ */
exports.getExpenseOptions = async (req, res) => {
  try {
    const list = await AdminExpenseMaster.find({ isActive: true })
      .sort({ label: 1 })
      .select("label -_id");

    res.json(list.map(i => i.label));
  } catch (err) {
    console.error("getExpenseOptions error", err);
    res.status(500).json({ message: "Failed to fetch expense options" });
  }
};

/* ===============================
   GET DOCUMENT DROPDOWN OPTIONS
================================ */
exports.getDocumentOptions = async (req, res) => {
  try {
    const list = await SellerDocumentMaster.find({ isActive: true })
      .sort({ label: 1 })
      .select("label -_id");

    res.json(list.map(i => i.label));
  } catch (err) {
    console.error("getDocumentOptions error", err);
    res.status(500).json({ message: "Failed to fetch document options" });
  }
};



exports.getSellerDocuments = async (req, res) => {
  try {
    const requests = await SellRequest.find({
      sellerDocuments: { $exists: true, $ne: [] }
    }).sort({ updatedAt: -1 });

    const result = requests.map(r => ({
      sellRequestId: r._id,

      car: {
        brand: r.car.brand,
        model: r.car.model,
        variant: r.car.variant,
        registrationNumber: r.car.registrationNumber,
      },

      seller: r.seller,

      documents: r.sellerDocuments, // {label, fileUrls[]}

      createdAt: r.createdAt,
    }));

    res.json(result);
  } catch (err) {
    console.error("getSellerDocuments error", err);
    res.status(500).json({ message: "Failed to load seller documents" });
  }
};



exports.getBuyerDocuments = async (req, res) => {
  try {
    const cars = await Car.find({ status: "SOLD" })

      .sort({ soldAt: -1 })   // üî• MOST IMPORTANT LINE
      .select("buyer buyerKyc buyerRto buyerPrice soldAt car _id");

    const response = cars.map((car) => ({
      id: car._id, // Add car ID for updates
      buyer: car.buyer,
      car: {
        brand: car.car?.brand,
        model: car.car?.model,
        variant: car.car?.variant,
        year: car.car?.year,
        registrationNumber: car.car?.registrationNumber,
      },
      soldPrice: car.buyerPrice,
      saleDate: car.soldAt,
      buyerKyc: car.buyerKyc,
      buyerRto: car.buyerRto,
    }));

    res.status(200).json(response);
  } catch (err) {
    console.error("‚ùå getBuyerDocuments error:", err);
    res.status(500).json({ message: "Failed to fetch buyer documents" });
  }
};

// UPDATE SELLER DOCUMENTS
exports.updateSellerDocuments = async (req, res) => {
  try {
    const { sellRequestId } = req.params;
    const { documents } = req.body;

    const sellRequest = await SellRequest.findById(sellRequestId);
    if (!sellRequest) {
      return res.status(404).json({ message: "Sell request not found" });
    }

    sellRequest.sellerDocuments = documents;
    await sellRequest.save();

    res.json({ message: "Seller documents updated successfully", sellRequest });
  } catch (err) {
    console.error("updateSellerDocuments error", err);
    res.status(500).json({ message: "Failed to update seller documents" });
  }
};

// UPDATE BUYER DOCUMENTS
exports.updateBuyerDocuments = async (req, res) => {
  try {
    const { carId } = req.params;
    const { buyerKyc, buyerRto } = req.body;

    const car = await Car.findById(carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    if (buyerKyc) {
      car.buyerKyc = { ...car.buyerKyc, ...buyerKyc };
    }

    if (buyerRto) {
      car.buyerRto = { ...car.buyerRto, ...buyerRto };
    }

    await car.save();

    res.json({ message: "Buyer documents updated successfully", car });
  } catch (err) {
    console.error("updateBuyerDocuments error", err);
    res.status(500).json({ message: "Failed to update buyer documents" });
  }
};





// ===============================
// GET FINAL INVOICE PDF
// ===============================
exports.getFinalInvoicePDF = async (req, res) => {
  try {
    const { saleId } = req.params;

    const sale = await Sale.findById(saleId);
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    if (sale.paymentSummary.status !== "PAID") {
      return res.status(400).json({
        message: "Final invoice available only after full payment",
      });
    }

    const car = await Car.findById(sale.carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    const payments = await Payment.find({ saleId }).sort({
      paymentDate: 1,
    });

    /* ================= PDF SETUP ================= */
    const doc = new PDFDocument({ margin: 50 });

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename=Final-Invoice-${saleId}.pdf`
    );

    doc.pipe(res);

    /* ================= HEADER ================= */
    doc.fontSize(18).text("Prajapati Mukati Motors", { align: "center" });
    doc.moveDown(0.5);
    doc.fontSize(10).text("Authorized Used Car Dealer", { align: "center" });
    doc.moveDown();

    doc.fontSize(14).text("FINAL INVOICE", { align: "center" });
    doc.moveDown(2);

    /* ================= BUYER ================= */
    doc.fontSize(11).text(`Buyer Name: ${car.buyer?.name}`);
    doc.text(`Phone: ${car.buyer?.phone}`);
    doc.text(`City: ${car.buyer?.city || "-"}`);
    doc.moveDown();

    /* ================= VEHICLE ================= */
    doc.text(`Car: ${car.car?.brand} ${car.car?.variant || ""}`);
    doc.text(`Registration No: ${car.car?.registrationNumber || "-"}`);
    doc.text(`Fuel: ${car.car?.fuelType || "-"}`);
    doc.moveDown();

    /* ================= PAYMENT SUMMARY ================= */
    doc.text(`Total Amount: ‚Çπ${sale.paymentSummary.totalAmount}`);
    doc.text(`Paid Amount: ‚Çπ${sale.paymentSummary.paidAmount}`);
    doc.text(`Remaining: ‚Çπ${sale.paymentSummary.remainingAmount}`);
    doc.text(`Status: ${sale.paymentSummary.status}`);
    doc.moveDown();

    /* ================= PAYMENT HISTORY ================= */
    doc.text("Payment Details:");
    doc.moveDown(0.5);

    payments.forEach((p, i) => {
      doc.text(
        `${i + 1}. ‚Çπ${p.amount} - ${p.paymentType} (${new Date(
          p.paymentDate
        ).toLocaleDateString()})`
      );
    });

    doc.moveDown(2);
    doc.text("This is a system generated invoice.", { align: "center" });

    doc.end();
  } catch (error) {
    console.error("‚ùå getFinalInvoicePDF error:", error);
    res.status(500).json({ message: "Server error" });
  }
};

// ===============================
// GET /api/admin/payments/:paymentId/pdf-cloudinary
// Generate Payment Invoice PDF and upload to Cloudinary
// ===============================
exports.getPaymentInvoicePDFCloudinary = async (req, res) => {
  try {
    const { paymentId } = req.params;

    /* ================= FIND PAYMENT ================= */
    const payment = await Payment.findById(paymentId).lean();
    if (!payment) {
      return res.status(404).json({ message: "Payment not found" });
    }

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(payment.saleId).lean();
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    /* ================= FIND CAR ================= */
    const carDoc = await Car.findById(payment.carId).lean();
    if (!carDoc) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= GENERATE PDF TO BUFFER ================= */
    const pdfBuffer = await new Promise((resolve, reject) => {
      const doc = new PDFDocument({ margin: 50 });
      const chunks = [];

      doc.on("data", (chunk) => chunks.push(chunk));
      doc.on("error", reject);
      doc.on("end", () => resolve(Buffer.concat(chunks)));

      /* ================= HEADER ================= */
      doc.fontSize(18).text("Prajapati Mukati Motors", { align: "center" });
      doc.moveDown(0.5);
      doc.fontSize(10).text("Authorized Used Car Dealer", { align: "center" });
      doc.moveDown();

      doc.fontSize(14).text("PAYMENT RECEIPT", { align: "center" });
      doc.moveDown(2);

      /* ================= INVOICE DETAILS ================= */
      doc.fontSize(11).text(`Invoice No: ${payment.invoiceNumber}`);
      doc.text(`Date: ${new Date(payment.invoiceDate).toLocaleDateString()}`);
      doc.moveDown();

      /* ================= BUYER ================= */
      doc.text(`Buyer Name: ${carDoc.buyer?.name || "-"}`);
      doc.text(`Phone: ${carDoc.buyer?.phone || "-"}`);
      doc.text(`City: ${carDoc.buyer?.city || "-"}`);
      doc.moveDown();

      /* ================= VEHICLE ================= */
      doc.text(`Car: ${carDoc.car?.brand} ${carDoc.car?.variant || ""}`);
      doc.text(`Registration No: ${carDoc.car?.registrationNumber || "-"}`);
      doc.text(`Fuel: ${carDoc.car?.fuelType || "-"}`);
      doc.moveDown();

      /* ================= PAYMENT DETAILS ================= */
      doc.text(`Payment Type: ${payment.paymentType}`);
      doc.text(`Payment Method: ${payment.paymentMethod || "-"}`);
      doc.text(`Amount Paid: ‚Çπ${payment.amount.toLocaleString("en-IN")}`);
      doc.text(`Date: ${new Date(payment.paymentDate).toLocaleDateString()}`);
      doc.moveDown();

      /* ================= SALE SUMMARY ================= */
      doc.text(
        `Total Vehicle Price: ‚Çπ${sale.paymentSummary.totalAmount.toLocaleString(
          "en-IN"
        )}`
      );
      doc.text(
        `Total Paid: ‚Çπ${sale.paymentSummary.paidAmount.toLocaleString(
          "en-IN"
        )}`
      );
      doc.text(
        `Remaining: ‚Çπ${sale.paymentSummary.remainingAmount.toLocaleString(
          "en-IN"
        )}`
      );
      doc.text(`Status: ${sale.paymentSummary.status}`);
      doc.moveDown(2);

      doc.text("Thank you for your business!", { align: "center" });
      doc.moveDown(0.5);
      doc.text("This is a system generated receipt.", { align: "center" });

      doc.end();
    });

    console.log("‚úÖ PDF Buffer generated:", pdfBuffer.length, "bytes");

    /* ================= UPLOAD TO CLOUDINARY ================= */
  const uploadResult = await new Promise((resolve, reject) => {
  const uploadStream = cloudinary.uploader.upload_stream(
    {
      resource_type: "raw",
      type: "upload",
      folder: "car-invoices/payments",
      public_id: `Payment-Invoice-${paymentId}`,
      access_mode: "public",
    },
    (error, result) => {
      if (error) return reject(error);
      resolve(result);
    }
  );

  uploadStream.end(pdfBuffer);
});


  console.log("‚úÖ PDF uploaded to Cloudinary:", uploadResult.secure_url);

  res.json({
    message: "PDF generated and uploaded successfully",
    pdfUrl: uploadResult.secure_url,
    fileName: `Payment-Invoice-${paymentId}.pdf`,
  });
} catch (error) {
  console.error("‚ùå getPaymentInvoicePDFCloudinary error:", error);
  res.status(500).json({ message: "Server error", error: error.message });
}
};

// ===============================
// GET /api/admin/sales/:saleId/final-invoice-pdf-cloudinary
// Generate Final Invoice PDF and upload to Cloudinary
// ===============================
exports.getFinalInvoicePDFCloudinary = async (req, res) => {
  try {
    const { saleId } = req.params;

    /* ================= FIND SALE ================= */
    const sale = await Sale.findById(saleId);
    if (!sale) {
      return res.status(404).json({ message: "Sale not found" });
    }

    if (sale.paymentSummary.status !== "PAID") {
      return res.status(400).json({
        message: "Final invoice available only after full payment",
      });
    }

    /* ================= FIND CAR ================= */
    const car = await Car.findById(sale.carId);
    if (!car) {
      return res.status(404).json({ message: "Car not found" });
    }

    /* ================= FIND PAYMENTS ================= */
    const payments = await Payment.find({ saleId }).sort({
      paymentDate: 1,
    });

    /* ================= GENERATE PDF BUFFER ================= */
    const pdfBuffer = await new Promise((resolve, reject) => {
      const doc = new PDFDocument({ margin: 50 });
      const chunks = [];

      doc.on("data", chunk => chunks.push(chunk));
      doc.on("error", reject);
      doc.on("end", () => resolve(Buffer.concat(chunks)));

      // ===== HEADER =====
      doc.fontSize(18).text("Prajapati Mukati Motors", { align: "center" });
      doc.moveDown(0.5);
      doc.fontSize(10).text("Authorized Used Car Dealer", { align: "center" });
      doc.moveDown();

      doc.fontSize(14).text("FINAL INVOICE", { align: "center" });
      doc.moveDown(2);

      // ===== SALE INFO =====
      doc.fontSize(11).text(`Sale ID: ${sale._id}`);
      doc.text(`Date: ${new Date(sale.createdAt).toLocaleDateString()}`);
      doc.moveDown();

      // ===== BUYER =====
      doc.text(`Buyer Name: ${car.buyer?.name || "-"}`);
      doc.text(`Phone: ${car.buyer?.phone || "-"}`);
      doc.text(`City: ${car.buyer?.city || "-"}`);
      doc.moveDown();

      // ===== VEHICLE =====
      doc.text(`Car: ${car.car?.brand} ${car.car?.variant || ""}`);
      doc.text(`Year: ${car.car?.year || "-"}`);
      doc.text(`Registration No: ${car.car?.registrationNumber || "-"}`);
      doc.text(`Fuel: ${car.car?.fuelType || "-"}`);
      doc.moveDown();

      // ===== PAYMENT SUMMARY =====
      doc.text(
        `Total Amount: ‚Çπ${sale.paymentSummary.totalAmount.toLocaleString("en-IN")}`
      );
      doc.text(
        `Paid Amount: ‚Çπ${sale.paymentSummary.paidAmount.toLocaleString("en-IN")}`
      );
      doc.text(`Status: ${sale.paymentSummary.status}`);
      doc.moveDown(2);

      // ===== PAYMENT HISTORY =====
      if (payments.length) {
        doc.fontSize(12).text("Payment History", { underline: true });
        doc.moveDown(0.5);

        payments.forEach((p, i) => {
          doc.fontSize(10).text(
            `${i + 1}. ‚Çπ${p.amount.toLocaleString("en-IN")} - ${
              p.paymentType
            } (${new Date(p.paymentDate).toLocaleDateString()})`
          );
        });

        doc.moveDown(2);
      }

      doc.text("Thank you for your business!", { align: "center" });
      doc.moveDown(0.5);
      doc.text("This is a system generated invoice.", { align: "center" });

      doc.end();
    });

    console.log("‚úÖ PDF Buffer generated:", pdfBuffer.length, "bytes");

    /* ================= UPLOAD TO CLOUDINARY ================= */
    const uploadResult = await new Promise((resolve, reject) => {
      const uploadStream = cloudinary.uploader.upload_stream(
        {
          resource_type: "raw",
          type: "upload",
          folder: "car-invoices/final",
          public_id: `Final-Invoice-${saleId}`,
          access_mode: "public",
        },
        (error, result) => {
          if (error) return reject(error);
          resolve(result);
        }
      );

      uploadStream.end(pdfBuffer);
    });

    console.log("‚úÖ PDF uploaded to Cloudinary:", uploadResult.secure_url);

    res.json({
      message: "Final invoice generated & uploaded successfully",
      pdfUrl: uploadResult.secure_url,
      fileName: `Final-Invoice-${saleId}.pdf`,
    });
  } catch (error) {
    console.error("‚ùå getFinalInvoicePDFCloudinary error:", error);
    res.status(500).json({
      message: "Server error",
      error: error.message,
    });
  }
};
